---
version: "3"

services:
  web:
    image: >-
      chamburr/modmail-web:latest@sha256:122f582d038f193967e222e901db70de1ee9dfcec9deeee674329df190f8c2e8
    restart: unless-stopped
    command:
      - /bin/sh
      - -c
      - echo "$CONFIG" > /.env && yarn start
    environment:
      - CONFIG=${CONFIG}
    networks:
      - traefik_default
    depends_on:
      - api

  api:
    image: >-
      chamburr/modmail-api:latest@sha256:f72bda7abb70ff8c55dcd63ae02e807712c68ae1ccf2ed4be702aa44cdec4ec1
    restart: unless-stopped
    command:
      - /bin/sh
      - -c
      - echo "$CONFIG" > /.env && ./modmail
    environment:
      - CONFIG=${CONFIG}
    depends_on:
      - bot
      - redis

  bot:
    image: >-
      chamburr/modmail-bot:latest@sha256:367bc971367498f50217f5de5bb80844e04c2a5719c1ce477b8eecd1ccbd6ae9
    restart: unless-stopped
    command:
      - /bin/sh
      - -c
      - echo "$CONFIG" > /.env && ./bin/entrypoint.sh
    environment:
      - CONFIG=${CONFIG}
    depends_on:
      - dispatch
      - postgres
      - redis
      - rabbitmq

  dispatch:
    image: >-
      chamburr/twilight-dispatch:latest@sha256:05e93610acea44625aef0dd788ad02b59df8984757775aabce33e953cedd1ca2
    restart: unless-stopped
    command:
      - /bin/sh
      - -c
      - echo "$CONFIG" > /.env && ./twilight-dispatch
    environment:
      - CONFIG=${DISPATCH_CONFIG}
    depends_on:
      - redis
      - rabbitmq

  postgres:
    image: postgres:15.1-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_DB=modmail
      - POSTGRES_HOST_AUTH_METHOD=trust
    volumes:
      - postgres:/var/lib/postgresql/data

  redis:
    image: eqalpha/keydb:x86_64_v6.3.1
    restart: unless-stopped
    volumes:
      - ${PWD}/keydb.conf:/etc/keydb/keydb.conf

  rabbitmq:
    image: rabbitmq:3.11.4-alpine
    restart: unless-stopped

networks:
  traefik_default:
    external: true

volumes:
  postgres:
